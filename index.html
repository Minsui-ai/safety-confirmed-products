import pandas as pd
from pypdf import PdfReader, PdfWriter
import os
import tkinter as tk
from tkinter import filedialog
from tkinter import messagebox
import sys

# --- íŒŒì¼ ë° í´ë” ì„ íƒ í•¨ìˆ˜ ì •ì˜ ---
def select_file(title_text, file_types):
    """íŒŒì¼ ì„ íƒ ëŒ€í™” ìƒìë¥¼ ì—´ê³  ì„ íƒëœ íŒŒì¼ ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    try:
        root = tk.Tk()
        root.withdraw() 
        file_path = filedialog.askopenfilename(
            title=title_text,
            filetypes=file_types
        )
        return file_path
    except Exception:
        return None

def select_directory(title_text):
    """í´ë” ì„ íƒ ëŒ€í™” ìƒìë¥¼ ì—´ê³  ì„ íƒëœ í´ë” ê²½ë¡œë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤."""
    try:
        root = tk.Tk()
        root.withdraw()
        dir_path = filedialog.askdirectory(
            title=title_text
        )
        return dir_path
    except Exception:
        return None

# --- ê²½ë¡œ ì„¤ì • ë° ìœ íš¨ì„± ê²€ì‚¬ ---
print("\n--- íŒŒì¼ ë° í´ë” ì„ íƒì„ ì‹œì‘í•©ë‹ˆë‹¤. ---")

# 1. ì›ë³¸ PDF íŒŒì¼ ê²½ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
SOURCE_PDF_PATH = select_file("â‘  ì›ë³¸ ìŠ¤ìº” PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", [("PDF files", "*.pdf")])
if not SOURCE_PDF_PATH:
    messagebox.showerror("ì˜¤ë¥˜", "PDF íŒŒì¼ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    sys.exit()
print(f"âœ… ì›ë³¸ PDF íŒŒì¼: {SOURCE_PDF_PATH}")

# 2. CSV/Excel íŒŒì¼ ê²½ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
EXCEL_FILE_PATH = select_file("â‘¡ ë¶„ë¦¬ ì •ë³´ê°€ ë‹´ê¸´ CSV/Excel íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”", [("CSV/Excel files", "*.csv *.xlsx *.xls")])
if not EXCEL_FILE_PATH:
    messagebox.showerror("ì˜¤ë¥˜", "ì •ë³´ íŒŒì¼ ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    sys.exit()
print(f"âœ… ì •ë³´ íŒŒì¼: {EXCEL_FILE_PATH}")

# 3. ì €ì¥ í´ë” ê²½ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
OUTPUT_DIR = select_directory("â‘¢ ë¶„ë¦¬ëœ PDF íŒŒì¼ì„ ì €ì¥í•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”")
if not OUTPUT_DIR:
    messagebox.showerror("ì˜¤ë¥˜", "ì €ì¥ í´ë” ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
    sys.exit()
print(f"âœ… ì €ì¥ í´ë”: {os.path.abspath(OUTPUT_DIR)}")

# ----------------------------------------
# --- 4. í”„ë¡œê·¸ë¨ í•µì‹¬ ë¡œì§ ---
# ----------------------------------------

# 4.1. CSV/Excel ë°ì´í„° ë¡œë“œ ë° ì •ë¦¬ (ğŸš¨ Aì—´ê³¼ Bì—´(í˜ì´ì§€ìˆ˜)ë§Œ ì‚¬ìš©ìœ¼ë¡œ ë³µêµ¬)
df = pd.DataFrame()
file_extension = os.path.splitext(EXCEL_FILE_PATH)[1].lower()

try:
    # ğŸš¨ğŸš¨ usecols=[0, 1]ë¡œ ì„¤ì •: Aì—´(0)ì„ 'ì ‘ìˆ˜ë²ˆí˜¸'ë¡œ, Bì—´(1)ì„ 'í˜ì´ì§€ìˆ˜'ë¡œ ì½ìŒ
    if file_extension == '.csv':
        df = pd.read_csv(
            EXCEL_FILE_PATH, 
            header=None,
            names=['ì ‘ìˆ˜ë²ˆí˜¸', 'í˜ì´ì§€ìˆ˜'],
            skiprows=1, # B1 í—¤ë” ê±´ë„ˆë›°ê¸°
            encoding='cp949',
            sep=',',
            usecols=[0, 1] # â¬…ï¸ Aì—´(0)ê³¼ Bì—´(1)ë§Œ ì„ íƒ
        )
    else: # .xlsx ë˜ëŠ” .xls íŒŒì¼ì¸ ê²½ìš°
        df = pd.read_excel(
            EXCEL_FILE_PATH, 
            sheet_name=0, 
            header=None,
            names=['ì ‘ìˆ˜ë²ˆí˜¸', 'í˜ì´ì§€ìˆ˜'],
            skiprows=1,
            usecols=[0, 1] # â¬…ï¸ Aì—´(0)ê³¼ Bì—´(1)ë§Œ ì„ íƒ
        )

    # ğŸš¨ğŸš¨ğŸš¨ ë””ë²„ê·¸ ì¶œë ¥: ì½ì–´ì˜¨ ì›ë³¸ ë°ì´í„° í™•ì¸ ğŸš¨ğŸš¨ğŸš¨
    print("\n--- ë””ë²„ê·¸ ì¶œë ¥: ì½ì–´ì˜¨ ë°ì´í„°ì˜ ì²« 5í–‰ ---")
    print(df.head())
    print("-------------------------------------------\n")


    # ë°ì´í„° ì •ë¦¬ ë° íƒ€ì… ë³€í™˜
    df.dropna(subset=['ì ‘ìˆ˜ë²ˆí˜¸', 'í˜ì´ì§€ìˆ˜'], how='all', inplace=True) 
    df['ì ‘ìˆ˜ë²ˆí˜¸'] = df['ì ‘ìˆ˜ë²ˆí˜¸'].astype(str).str.strip()
    
    # í˜ì´ì§€ìˆ˜ ê°•ì œ ì •ìˆ˜ ë³€í™˜ (ì˜¤ë¥˜ ë°œìƒ ê°’ì€ -1ë¡œ ì²˜ë¦¬ í›„ ì œê±°)
    df['í˜ì´ì§€ìˆ˜'] = pd.to_numeric(df['í˜ì´ì§€ìˆ˜'], errors='coerce').fillna(-1).astype(int)
    df = df[df['í˜ì´ì§€ìˆ˜'] > 0] 

    # ìœ íš¨í•œ ì ‘ìˆ˜ ê±´ìˆ˜ í™•ì¸
    if len(df) == 0:
        messagebox.showerror("ì˜¤ë¥˜", "ì •ë³´ íŒŒì¼ì—ì„œ ìœ íš¨í•œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n\nğŸš¨ ìµœì¢… ì ê²€: A2ì™€ B2ì— ë°ì´í„°ê°€ ìˆê³ , Bì—´ ë°ì´í„°ê°€ ìˆ«ìì¸ì§€ í™•ì¸í•˜ì„¸ìš”.")
        sys.exit()

except FileNotFoundError:
    messagebox.showerror("ì˜¤ë¥˜", "ì •ë³´ íŒŒì¼ ê²½ë¡œê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.")
    sys.exit()
except PermissionError:
    messagebox.showerror("ì˜¤ë¥˜", "ì •ë³´ íŒŒì¼ ì ‘ê·¼ ì˜¤ë¥˜.\n\nğŸš¨ ì›ì¸: í•´ë‹¹ íŒŒì¼ì´ í˜„ì¬ **ì—´ë ¤ ìˆì§€ ì•Šì€ì§€** ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ê³ , **ë‹«ì€ í›„** ë‹¤ì‹œ ì‹œë„í•˜ì‹­ì‹œì˜¤.")
    sys.exit()
except Exception as e:
    messagebox.showerror("ì˜¤ë¥˜", f"ì •ë³´ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ ë°œìƒ: {e}")
    sys.exit()

# 4.2. PDF íŒŒì¼ ì½ê¸°
try:
    reader = PdfReader(SOURCE_PDF_PATH)
    total_pdf_pages = len(reader.pages)
except Exception as e:
    messagebox.showerror("ì˜¤ë¥˜", f"PDF íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
    sys.exit()

# 4.3. ë°˜ë³µ ë° í˜ì´ì§€ ëˆ„ì  ê³„ì‚°ì„ í†µí•œ ë¶„ë¦¬
current_page_index = 0
print(f"\n--- ì´ {total_pdf_pages}í˜ì´ì§€ PDFë¥¼ {len(df)}ê±´ìœ¼ë¡œ ë¶„ë¦¬ ì‹œì‘ ---")

for index, row in df.iterrows():
    try:
        ì ‘ìˆ˜ë²ˆí˜¸ = row['ì ‘ìˆ˜ë²ˆí˜¸']
        í˜ì´ì§€ìˆ˜ = row['í˜ì´ì§€ìˆ˜']
        start_index = current_page_index
        end_index = current_page_index + í˜ì´ì§€ìˆ˜
        
        if í˜ì´ì§€ìˆ˜ <= 0: continue
        if start_index >= total_pdf_pages:
            print(f"âš ï¸ ê²½ê³ : {ì ‘ìˆ˜ë²ˆí˜¸}ì˜ ì‹œì‘ í˜ì´ì§€({start_index + 1}p)ê°€ ì›ë³¸ PDFì˜ ì´ í˜ì´ì§€ë¥¼ ì´ˆê³¼í•˜ì—¬ ë¶„ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤.")
            break 
            
        safe_ì ‘ìˆ˜ë²ˆí˜¸ = "".join(c for c in ì ‘ìˆ˜ë²ˆí˜¸ if c.isalnum() or c in (' ', '_', '-'))
        output_filename = os.path.join(OUTPUT_DIR, f"{safe_ì ‘ìˆ˜ë²ˆí˜¸}.pdf")
        writer = PdfWriter()
        pages_extracted = 0
        
        for page_num in range(start_index, end_index):
            if page_num >= total_pdf_pages:
                print(f"âš ï¸ ê²½ê³ : {ì ‘ìˆ˜ë²ˆí˜¸} ë¶„ë¦¬ ì¤‘ ì›ë³¸ PDFì˜ ë({total_pdf_pages}p)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œ ë¶„ë¦¬ë¥¼ ë§ˆì¹©ë‹ˆë‹¤.")
                break 
            writer.add_page(reader.pages[page_num])
            pages_extracted += 1

        if pages_extracted > 0:
            with open(output_filename, "wb") as output_pdf:
                writer.write(output_pdf)
            
            current_page_index = start_index + pages_extracted
            start_p_num = start_index + 1
            end_p_num = current_page_index
            
            print(f"âœ… ì„±ê³µ: {ì ‘ìˆ˜ë²ˆí˜¸} ({start_p_num}p ~ {end_p_num}p, ì´ {pages_extracted}ì¥) -> {os.path.basename(output_filename)}")
        else:
             print(f"âŒ ì‹¤íŒ¨: {ì ‘ìˆ˜ë²ˆí˜¸} (Excel ì •ë³´: {í˜ì´ì§€ìˆ˜}ì¥). í˜ì´ì§€ê°€ ì¶”ì¶œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    except Exception as e:
        print(f"âŒ ì˜¤ë¥˜: {ì ‘ìˆ˜ë²ˆí˜¸} ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {e}")
        current_page_index = end_index 
        
print("\n--- ëª¨ë“  íŒŒì¼ ë¶„ë¦¬ ì‘ì—… ì™„ë£Œ ---")
messagebox.showinfo("ì™„ë£Œ", "PDF ë¶„ë¦¬ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì½˜ì†” ì°½ì—ì„œ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.")
